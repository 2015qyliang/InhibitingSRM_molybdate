# coding: utf-8
# email: qfsfdxlqy@163.com
# Github: https://github.com/2015qyliang

##########################################################################

library(igraph)
library(brainGraph)
library(tidyverse)
library(NetSwan)
library(ggplot2)
library(ggsci)

##########################################################################

getMinE = function(fn){
  nodes = read.table(paste0('./NetInfo/', fn,' node_attribute.txt'), 
                     header = T, sep = '\t', stringsAsFactors = F)
  nodes$No..module = paste0('M_', nodes$No..module)
  rownames(nodes) = nodes$id
  links = read.table(paste0('./NetInfo/', fn,' edge_attribute.txt'),
                     header = T, sep = '\t', stringsAsFactors = F)
  net.graph = graph_from_data_frame( d = links, vertices = nodes, directed = F)
  
  e.global = efficiency(net.graph, type = 'global')
  
  e.nodes = c()
  for (nd in nodes$id) {
    nodes.nd = nodes[nodes$id != nd, ]
    links.nd = links[(links$from != nd) & (links$to != nd) , ]
    net.graph.nd = graph_from_data_frame( d = links.nd, vertices = nodes.nd, directed = F)
    e.nd = efficiency(net.graph.nd, type = 'global')
    e.nodes = append(e.nodes, e.nd)
  }
  
  return(c(e.global, round(max((e.global-e.nodes)/e.global), digits = 4)))
}

##########################################################################

sampleGroups = read.table('01-RMTvalue.txt', header = T, sep = '\t', stringsAsFactors = F)
vulnerability = c()
efficient = c()
for (i in 1:length(sampleGroups$groups)) {
  fn = paste0(sampleGroups$groups[i], ' ', sprintf('%0.2f', sampleGroups$value[i]))
  efficient = append(efficient, getMinE(fn)[1])
  vulnerability = append(vulnerability, getMinE(fn)[2]) 
}

vulDF = data.frame(Group = sampleGroups$groups, efficient, vulnerability)

write.table(vulDF, '03-Vulnerability.txt', append = F, sep = '\t', row.names = F, col.names = T)

##########################################################################
##########################################################################
##########################################################################

vulDF = read.table('03-Vulnerability.txt', header = T, sep = '\t', stringsAsFactors = F)
m.vuldf = vulDF[vulDF$Group == 'D00C', ]
m.vuldf$Group = 'D00M'
vulDF = rbind(vulDF, m.vuldf)

vulDF$TimeGp = as.integer(substr(vulDF$Group, 2, 3))
vulDF$GP = substr(vulDF$Group, 4, 4)

p = ggplot(vulDF, aes(x = TimeGp, y = vulnerability, color = GP, group = GP)) +
  geom_point(size = 1) + 
  geom_smooth(method = "lm", se = F, size = 0.3, alpha = 0.5) + 
  scale_color_manual(values = c('#E69F00', '#0072B2'))+ 
  labs(x= NULL, y = 'Vulnerability') +
  theme( panel.background = element_rect(fill="white",color="black"),
         panel.grid = element_blank(), 
         axis.text.x = element_text(size = 10),
         axis.text.y = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
         axis.title.y = element_text(size = 10), 
         legend.position = 'none')

ggsave('04-Vulnetability.pdf', p, units = 'in', width = 3, height = 2.5)

################################################

vulDF$time = as.integer(substr(vulDF$Group, 2, 3))

vulDF.lm = vulDF[vulDF$GP == 'C', ]
res = summary(lm(vulDF.lm$vulnerability~vulDF.lm$time))
res$coefficients[,'Estimate'][1]
res$r.squared
res$coefficients[,'Pr(>|t|)'][2]
# > res$coefficients[,'Estimate'][1]
# (Intercept) 
# 0.03646159 
# > res$r.squared
# [1] 0.3342356
# > res$coefficients[,'Pr(>|t|)'][2]
# vulDF.lm$time 
# 0.3072565 

